name: ETL + dbt â€” Staging

on:
  schedule:
    - cron: '0 03 * * *'   # daily at 03:00 UTC
  push:
    branches:
      - staging
  workflow_dispatch:
    inputs:
      run_etl:
        description: 'Run Python ETL (scripts/run_pipeline.py)'
        required: false
        default: 'true'
      run_dbt:
        description: 'Run dbt (run models)'
        required: false
        default: 'true'

jobs:
  run:
    runs-on: ubuntu-latest
    environment: staging
    env:
      # DB env vars available to all steps (ETL + dbt)
      DB_HOST: ${{ secrets.STAGING_DB_HOST }}
      DB_PORT: ${{ secrets.STAGING_DB_PORT }}
      DB_USER: ${{ secrets.STAGING_DB_USER }}
      DB_PASS: ${{ secrets.STAGING_DB_PASS }}
      DB_NAME: ${{ secrets.STAGING_DB_NAME }}
      STAGING_SCHEMA: ${{ secrets.STAGING_SCHEMA }}
      INTERMEDIATE_SCHEMA: ${{ secrets.INTERMEDIATE_SCHEMA }}
      MART_SCHEMA: ${{ secrets.MART_SCHEMA }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: python -m pip install --upgrade pip && pip install -r requirements.txt

      - name: Run ETL (staging)
        if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.run_etl == 'true') || github.event_name == 'schedule' }}
        env:
          ENV: staging
        run: python scripts/run_pipeline.py

      - name: Run dbt (staging)
        if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.run_dbt == 'true') || github.event_name == 'schedule' }}
        run: |
          dbt run --profiles-dir dbt --project-dir dbt --target staging