name: ETL + dbt

on:
  schedule:
    - cron: "41 4 * * *"
  workflow_dispatch:
    inputs:
      run_etl:
        description: 'Run Python ETL (scripts/run_pipeline.py)'
        required: false
        default: 'true'
      run_dbt:
        description: 'Run dbt (run models)'
        required: false
        default: 'true'
  push:
    branches:
      - staging
      - main

jobs:
  run:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'prod' || 'staging' }}
    env:
      APP_ENV: ${{ github.ref_name == 'main' && 'prod' || 'staging' }}

      # Canonical database URL
      DATABASE_URL: ${{ github.ref_name == 'main' && secrets.DATABASE_URL_PROD || secrets.DATABASE_URL_STAGING }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ----------------------------
      # Parse DATABASE_URL for dbt (session pooler URL)
      # ----------------------------
      - name: Parse DATABASE_URL into DB_* env vars
        shell: bash
        run: |
          python - <<'EOF'
          import os
          from urllib.parse import urlparse

          url = urlparse(os.environ["DATABASE_URL"])

          # The user is url.username, host is url.hostname, db is path.lstrip('/')
          github_env = os.environ['GITHUB_ENV']
          with open(github_env, 'a') as f:
              f.write(f"DB_HOST={url.hostname}\n")
              f.write(f"DB_PORT={url.port or 5432}\n")
              f.write(f"DB_USER={url.username}\n")
              f.write(f"DB_PASS={url.password}\n")
              f.write(f"DB_NAME={url.path.lstrip('/')}\n")
          EOF

      # ----------------------------
      # Canonical schema env vars
      # ----------------------------
      - name: Set canonical schema env vars
        run: |
          echo "RAW_SCHEMA=raw" >> $GITHUB_ENV
          echo "STAGING_SCHEMA=staging" >> $GITHUB_ENV
          echo "INTERMEDIATE_SCHEMA=intermediate" >> $GITHUB_ENV
          echo "MART_SCHEMA=mart" >> $GITHUB_ENV

      # ----------------------------
      # Run ETL
      # ----------------------------
      - name: Run ETL
        if: >
          (github.event_name == 'workflow_dispatch' && github.event.inputs.run_etl == 'true') ||
          github.event_name == 'schedule' ||
          github.event_name == 'push'
        run: |
          echo "Running ETL for $APP_ENV"
          python -m scripts.run_pipeline

      # ----------------------------
      # Run dbt
      # ----------------------------
      - name: Run dbt
        if: >
          (github.event_name == 'workflow_dispatch' && github.event.inputs.run_dbt == 'true') ||
          github.event_name == 'schedule' ||
          github.event_name == 'push'
        run: |
          echo "Running dbt for $APP_ENV"
          dbt run --profiles-dir dbt --project-dir dbt --target $APP_ENV